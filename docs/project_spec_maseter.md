# The AWASE アワセ特化型ヘラブナ釣り物理シミュレータ マスター要件定義書

**Project Name:** Hera Physics Simulator (HPS)

**Version:** 0.9 (Draft)

**Target Platform:** macOS (Apple Silicon M2), Python (Pygame)

**Author:** Hiroshi Igarashi / AI Assistant

---

## 1. プロジェクト概要

### 1.1 コンセプト

**「引き算の美学と、物理演算の深淵」**

一般的な釣りゲームにおける「魚とのファイト（やり取り）」を完全に排除し、ヘラブナ釣りにおいて最も奥深く、かつ繊細な**「アタリを見極め、アワセる瞬間」**のみに特化したシミュレータ。

ウキの微細な挙動を微分方程式ベースの物理演算で再現し、プレイヤーの観察眼と反射神経、そして推論能力（Active Inference）を問う。

### 1.2 コア・バリュー

1. **完全物理駆動:** すべての挙動（ウキの揺れ、糸フケ、エサのバラケ）を乱数ではなく物理法則で記述する。
    
2. **実在プロパティ:** 実在するウキやエサの物理特性（寸法・比重・溶解度）を反映可能にする。
    
3. **不完全情報の推論:** ウキという限られた「観測窓」から、水中の「隠れ状態（魚の向き・食い気）」を推定する逆問題解決の楽しさを提供する。
    

---

## 2. システムアーキテクチャ

### 2.1 物理エンジン・コア

- **数値積分法:** シンプレクティック積分（Verlet法 / Leap-frog法）
    
    - _選定理由:_ 衝突や急激な張力変化に対するエネルギー保存性が高く、長時間のシミュレーションでも挙動が発散しにくい（安定性重視）。
        
- **時間刻み ($\Delta t$):** 16ms (60FPS固定) またはそれ以下の固定ステップ。
    

### 2.2 入力インターフェース

- **デバイス:** MacBook Air トラックパッド（高精細タッチ入力）。
    
- **マッピング方式:** 絶対座標マッピング（Absolute Mapping）。
    
    - パッド上の指の位置 $(x, y)$ を、竿を握る手元の位置 $(x_{hand}, y_{hand})$ に直結させる。
        
    - これにより「ゆっくり誘う」「瞬時に弾く」というアナログ操作をシームレスに実現する。
        

---

## 3. 物理モデリング詳細仕様

### 3.1 竿（Rod）モデル

- **モデル構造:** 集中定数系近似（Lumped Parameter Model）。
    
    - 「手元」と「竿先」をバネ・ダンパで結合した2質点系として記述。
        
- **運動方程式:**
    
    $$M_{rod}\ddot{x}_{tip} + C_{rod}\dot{x}_{tip} + K_{rod}(x_{tip} - x_{hand}) = F_{line}$$
    
- **特性:**
    
    - 急操作に対する「遅れ（慣性）」と、停止時の「おつり（減衰振動）」を再現。
        
    - パラメータ $K_{rod}$ (硬さ) の調整により、軟調子・硬調子の竿を表現可能。
        

### 3.2 道糸（Line）モデル

- **構造:** 不感帯（Dead Zone）付きバネモデル。
    
- **張力計算:**
    
    $$T = \begin{cases} k(\Delta L) & (\Delta L > L_{slack}) \\ 0 & (\text{otherwise}) \end{cases}$$
    
- **界面物理（Surface Tension）:**
    
    - **水切り（Water Cutting）:** キャスト直後は「表面張力フラグ」がTrueとなっており、張力伝達率が著しく低い（$\approx 10\%$）。
        
    - **解除条件:** 竿先を水面下へ一定速度以上で押し込む操作（メンディング）を検知した瞬間にフラグを解除し、張力伝達を100%にする。
        

### 3.3 ウキ（Float）モデル

- **アプローチ:** White Box Model（幾何形状からの物理量導出）。
    
- **浮力計算:**
    
    - トップ、ボディ、足の各パーツを円柱・円錐台の集合として定義。
        
    - 喫水深 $h$ に応じた排水体積 $V(h)$ をリアルタイム計算し、浮力 $F_b = \rho g V(h)$ を算出。
        
- **抵抗項:**

    - 流体抵抗（モリソン式ベース）：速度の二乗に比例。

    - **メニスカス効果（Meniscus）:** 水面との接点において、微小変位に対する強い粘性抵抗（非線形ダンパ）を付与し、「馴染んだ後の静止安定性」を高める。

- **姿勢制御（メタセントリック安定性）:**

    - **状態変数:** 角度 $\theta$ (rad)、角速度 $\omega$ (rad/s) を追加。

    - **浮上判定:** トップ先端位置 $y > L_{top}$（トップが完全に空中）のとき、浮力中心が低下し安定性を喪失。

    - **角度変化則（簡易版）:**

        $$\theta_{new} = \theta + (\theta_{target} - \theta) \cdot \lambda \cdot \Delta t$$

        - $\theta_{target} = \pi/2$ (水平) if $y > L_{top}$ （倒れる）
        - $\theta_{target} = 0$ (直立) otherwise （立つ）
        - $\lambda = 5.0$ : 減衰係数（指数的に目標角度へ収束）

    - **物理的意図:** 実釣では「ウキが立つ/寝る」が重要な視覚情報。トップ全露出時の倒伏を再現。

### 3.4 エサ（Bait）モデル

- **可変質量系:** 時間経過と相互作用により質量 $m(t)$ が減少する。
    
    $$\frac{dm}{dt} = - (k_{base} + \alpha |v|^2 + \beta F_{collision})$$
    
    - $k_{base}$: 自然溶解（バラケ性）。
        
    - $\alpha |v|^2$: 誘い（動かしすぎ）による剥離。
        
    - $\beta F_{collision}$: 魚のサワリによる欠損。
        
- **拡散（Diffusion）：**
    
    - 質量減少分を「匂いパーティクル」として水中に放出。
        
    - パーティクルはブラウン運動（ランダムウォーク）し、濃度勾配を形成する。
        

---

## 4. ゲームロジック & AI仕様

### 4.1 魚（Fish）AI

- **構成:** 自律エージェント（楕円体コライダー ＋ 吸い込みアクチュエータ）。
    
- **知覚:**
    
    1. **視覚:** エサとの距離。
        
    2. **嗅覚:** 周囲の「匂いパーティクル」の密度検知。
        
- **ステートマシン:**
    
    - `IDLE`: ランダム徘徊。
        
    - `APPROACH`: 匂い・視覚刺激によりエサへ接近。
        
    - `ATTACK`: 確率および内部状態（空腹度 vs 警戒心）に基づき吸い込みを実行。
        
    - `COOLDOWN`: 攻撃後、一時的に離脱。
        

### 4.2 アタリ生成メカニズム

- **サワリ（False Bite）:** 魚体（楕円剛体）が道糸・ウキ・エサに衝突した際の物理的衝撃。
    
- **食い（True Bite）:**
    
    - **吸い込み力場:** 口元を中心としたガウス分布状の引力ベクトル場を生成。
        
        $$\vec{F}_{suck}(t) = A(t) \cdot \exp(-r^2) \cdot \vec{n}$$
        
    - $A(t)$: 立ち上がり時間 $\tau$ を持つサージ関数（鋭さのパラメータ）。
    
    - **事後動作 (Post-Attack Motion):**
        - **食い上げ (Kuiage):** 吸い込みながら上方向 ($+y$) へ移動。ウキの荷重を抜く。
        - **消し込み (Keshikomi):** 吸い込みながら下方向 ($-y$) または後方へ移動。ウキを強く引き込む。

- **サワリ (Sawari):**
    - 魚がエサやハリスの近く ($d < 10cm$) を通過する際に発生する擾乱。
    - 微弱なランダムベクトル場（水流）として道糸・ウキ・エサに作用し、「フワフワ」した動きを生む。

- **アタリ返し (Atari-gaeshi):**
    - エサの質量 $m(t)$ が閾値を下回り、拡散が最大化したタイミング（エサ落ち直前）で発生する特異的な食い。
    - 魚の `ATTACK` 確率をエサ残量に反比例して上昇させることで再現。
        

### 4.3 フッキング（アワセ）判定

- **判定ロジック:** ベクトル内積判定。
    
    - 条件1: 魚が `ATTACK` 状態（吸い込み中）であること。
        
    - 条件2: 竿の上昇速度が閾値を超えていること（鋭いアワセ）。
        
    - 条件3: 道糸が「水切り」済みで、張力が伝達されていること。
        
    - 条件4: **ベクトル整合性:** アワセの方向ベクトルと、魚の吸い込み方向ベクトルの内積が一定以上であること（向こうアワセの概念）。
        

---

## 5. UI/UX & グラフィックス仕様

### 5.1 画面構成（Dual View System）

- **左画面：Macro View（主観視点）**
    
    - ウキのトップのみを超拡大表示。
        
    - **被写界深度（DoF）表現:** 背景をボカし、トップのメモリのみを鮮明に描画。
        
    - **レンダリング:** 実写テクスチャ素材（透過PNG）を用いたビルボード描画によるフォトリアル表現。
        
- **右画面：Debug View（水中透視図）**
    
    - 竿先、道糸の軌跡（スラック）、ウキ、エサ、魚、拡散パーティクルを一望できる断面図。
        
    - 水面下には青色のカラーフィルターを適用し、視認性を確保しつつ水中感を演出。
        

### 5.2 聴覚フィードバック（Procedural Audio）

- **合成ロジック:** 録音データの再生ではなく、物理量からのリアルタイム合成（予定）。
    
    - **Pitch (音程):** 道糸の張力 $T$ に比例。
        
    - **Gain (音量):** 竿の速度 $|v|$ に比例。
        
    - **Tone (音色):** 鋭い操作なら高周波ノイズ（風切り音）、重い操作なら低周波（水切り音）。
        

---

## 6. データ構造（JSON Schema）

### 6.1 ウキ定義 (Float Asset)

JSON

```
{
  "name": "Winter Standard PC",
  "top": { "material": "PC_SOLID", "length": 120, "diameter_tip": 0.6, "diameter_root": 1.0 },
  "body": { "material": "PEACOCK", "length": 50, "diameter": 6.0 },
  "foot": { "material": "CARBON", "length": 60 }
}
```

### 6.2 エサ定義 (Bait Asset)

JSON

```
{
  "name": "S-Design Red",
  "density": 1.4,
  "dissolution_speed": 0.05,
  "diffusion_rate": 2.0,
  "impact_resistance": 0.8
}
```

---

## 7. 開発ロードマップ（今後の指針）

1. **Phase 1: 物理コアの完成（完了）**
    
    - 竿・糸・ウキ・魚・拡散の基本連成の実装。
        
2. **Phase 2: グラフィックの深化（現在進行中）**
    
    - 実写素材への置き換え（Level 1 Graphic）。
        
    - 水面マスク処理とパーティクル描画の最適化。
        
3. **Phase 3: オーディオの実装（Next Step）**
    
    - PyAudio または Pygame.mixer を用いたプロシージャル効果音の実装。
        
4. **Phase 4: ゲームサイクルの確立**
    
    - スコアシステム、時間制限、ウキ・エサの選択メニューの実装。
        
5. **Phase 5: パラメータ調整（Tuning）**

    - 「気持ちいいアタリ」と「理不尽なスレ」のバランス調整。

---

## 8. 新数学的ダイナミクス理論（2026年2月実装）

### 8.1 背景と目的

Web調査および専門家チーム（数理学者、流体物理学者、ヘラブナ釣りの達人）による分析の結果、実装と実釣の物理に以下の重大なギャップが判明：

1. **サワリの時間相関欠落**: 実装はホワイトノイズ（16ms）、実釣は流体的な100-300ms相関
2. **吸い込み力の空間スケール誤り**: 実装20cm、実釣1-2cm（**100倍のギャップ**）
3. **ツンの立ち上がり遅延**: 実装150ms、実釣<50ms（**3倍遅い**）
4. **Verlet積分器が名前だけ**: 実装は実質オイラー法、エネルギー保存性なし
5. **食い上げのハリス張力欠落**: 魚の上昇がウキに伝達されない

これらを解決するため、新しい数学的ダイナミクス理論を導入する。

### 8.2 シンプレクティック積分法（真のVelocity Verlet）

**問題:** 既存の `integrator.py` は名前だけVelocity Verletで、実装は実質オイラー法。

**新定式化:**
```
真のVelocity Verlet法（シンプレクティック積分）:
  x(n+1) = x(n) + v(n)·Δt + 0.5·a(n)·Δt²
  a(n+1) = F(x(n+1)) / m  ← 新位置で加速度を再計算
  v(n+1) = v(n) + 0.5·(a(n) + a(n+1))·Δt  ← 平均加速度を使用
```

**利点:**
- エネルギー保存性が O(Δt²) → O(Δt⁴) に向上
- 長時間シミュレーション（> 10秒）での発散を防止
- ウキの「なじみ」後の微細振動がより自然に

**実装:** `physics/integrator.py` に `verlet_integrate_symplectic()` を追加。

### 8.3 Ornstein-Uhlenbeck過程（サワリの時間相関）

**問題:** 既存の `fish.py` の `_approach_behavior()` で生成されるサワリは完全ホワイトノイズ（16ms相関）。実釣では100-300msの流体的相関が観察される。

**新定式化:**
```
Ornstein-Uhlenbeck過程:
  dX = -θ(X - μ)dt + σ·dW
  離散化: X(n+1) = X(n) - θ·X(n)·dt + σ·√dt·N(0,1)

パラメータ:
  θ = 1/τ = 1/0.15 = 6.67 (時定数150ms)
  σ = 0.01 (強度)
  μ = 0 (平均ゼロ: 左右対称な揺れ)
```

**物理的意味:**
- 魚体周辺のストークス流（ウェイク）を近似
- 時間相関により「フワフワ」とした連続的な動き
- 実釣の「サワリ」と「モゾ」の区別が可能に

**期待効果:** サワリの時間相関が **19倍改善**（16ms → 150ms）

### 8.4 双極子吸込力場（1.5cm制限）

**問題:** 既存の吸込力場 `exp(-distance²)` は実効範囲が20cm。実際のヘラブナの吸口径は4-6mm、吸引力の作用距離は1-2cm。

**新定式化:**
```
双極子型の力場:
  F_suck(r) = A(t) · (r/r₀)² · exp(-r/r₀) · n̂

パラメータ:
  r₀ = 0.015m (1.5cm: 口径の2-3倍)
  範囲制限: r > 0.05m で force = 0（5cm超では無視）
```

**物理的根拠:**
- ヘラブナの吸引圧: 0.5-2.0 kPa（弱い）
- 双極子場は `(r/r₀)²` により急峻に減衰
- 実釣の「ピンポイント」な吸い込みを再現

**期待効果:** 吸い込み範囲が **100倍精密化**（20cm → 1.5cm）

### 8.5 ツンの3段階モデル（50ms立ち上がり）

**問題:** 既存のサージ関数 `exp(-((t-0.5)²)/0.1)` はピーク到達が150ms。実釣の「ツン」は50-100msで最大深度に到達する瞬発力。

**新定式化:**
```
3段階モデル:
  準備 (0-30ms):   A(t) = 0.5 · (t/0.03)
  爆発 (30-80ms):  A(t) = 5.0 · exp(-((t-0.05)²) / (2·0.01²))
  減衰 (80-300ms): A(t) = 5.0 · exp(-(t-0.08) / 0.1)
```

**物理的意味:**
- 準備: 口を開く動作（弱い吸引）
- 爆発: 鰓蓋を閉じて爆発的に吸引（50msでピーク）
- 減衰: ハリス張力に抗い、離脱開始

**期待効果:** ツンの立ち上がりが **3倍高速化**（150ms → 50ms）

### 8.6 ラグランジュ乗数法（ハリス拘束と食い上げ/消し込み）

**問題:** 魚が食い上げ（上昇）しても、ハリス張力がウキに伝達されない。物理的な閉ループが不完全。

**新定式化:**
```
拘束条件: |r_bait - r_float| = L_tippet
ラグランジュ乗数 λ:
  F_constraint = λ · n̂  (n̂: ハリス方向単位ベクトル)

λ = (m_bait·a_bait + m_float·a_float) · n̂ / (1/m_bait + 1/m_float)

魚がATTACK中（エサをホールド）:
  T_tippet = m_bait · (g - a_fish[y])

  if a_fish[y] > g (魚が上昇):
    T_tippet < 0 → ウキを下から引く（食い上げ）
  else:
    T_tippet > 0 → ウキを上から押す（消し込み）
```

**物理的意味:**
- 魚がエサを咥えている間、魚の加速度がハリスを通じてウキに伝達
- 食い上げ時: ウキが浮上（荷重が抜ける）
- 消し込み時: ウキが沈降（引き込まれる）

**期待効果:**
- 食い上げでウキがスーッと浮く
- 消し込みでウキがズバッと沈む
- アタリの種類が明確に区別可能

### 8.7 水切り状態の連続遷移

**問題:** 既存の水切り状態は離散スイッチ（SPACEキーで 0.1 → 1.0 に瞬間変化）。実際の表面張力破断は連続的（時定数～100ms）。

**新定式化:**
```
連続的な遷移:
  transmission(t) = 0.1 + 0.9 · (1 - exp(-t/τ))

パラメータ:
  τ = 0.5s (水切り後の馴染み時定数)
```

**物理的意味:**
- 表面張力の破断は瞬間的ではなく、徐々に馴染む
- 水切り直後の急激な張力変化による非物理的な振動を防止

**期待効果:** 水切り後の張力伝達が自然に

### 8.8 アタリの定量化（目盛り数の物理的決定）

**問題:** アタリの大きさが定性的。実釣では「1目盛り沈んだ」など定量的に評価される。

**新定式化:**
```
ウキの目盛り移動量:
  Δy_float = ∫(F_net / m_float) dt

物理スケール:
  1目盛り = 3mm (PC製トップの典型値)

典型的なアタリ:
  ツン: Δy = -5mm (1-2目盛り沈み)
  食い上げ: Δy = +10mm (3-4目盛り浮上)
  消し込み: Δy = -15mm (5目盛り沈み)
```

**実装:** `main.py` に `AtariDetector` クラスを追加し、ウキの位置履歴から目盛り数をカウント。

**期待効果:**
- アタリの大きさが定量的に評価可能
- スコアリングの根拠が明確に
- プレイヤーへのフィードバックが具体的に

### 8.9 トルクベース姿勢制御（メタセントリック復元モーメント）

**問題:** 既存のウキ姿勢制御は運動学的（目標角度への指数関数的収束）。物理的なトルクバランスがない。

**新定式化:**
```
角運動方程式:
  I·α = τ_restore

復元モーメント:
  τ_restore = (B - G) · sin(θ) · d_BG

慣性モーメント:
  I = (1/12) · m · L²  (細長い棒の近似)

浮力中心距離:
  d_BG = d_BG(喫水深)  ← 喫水が変わると浮力中心が移動
```

**物理的意味:**
- トップが完全に空中に出ると、浮力中心が低下 → 復元力消失 → 倒伏
- 喫水が深いと、浮力中心が上昇 → 復元力増加 → 安定

**期待効果:**
- 「ウキが立つ/寝る」がより自然に
- 倒伏の速度が浮力変化に動的に反応

### 8.10 実装スケジュール

| Phase | 内容 | 期間 | 重要度 |
|-------|------|------|--------|
| Phase 1 | シンプレクティック積分 | Week 1 | 最高 |
| Phase 2 | FishAI高度化（OU過程、双極子、ツン3段階） | Week 2 | 高 |
| Phase 3 | ハリス拘束、トルク姿勢制御 | Week 3 | 中 |
| Phase 4 | 水切り連続遷移、目盛り定量化 | Week 4 | 低 |

**Critical Success Factors:**
- Phase 1とPhase 2の完了で、体感的な質が劇的に向上
- Phase 3で食い上げ/消し込みの区別が明確に
- Phase 4でゲームロジックが洗練

**性能目標:**
- Phase 1-2, 4: 60fps維持
- Phase 3: 50fps程度（ラグランジュ拘束の計算負荷）